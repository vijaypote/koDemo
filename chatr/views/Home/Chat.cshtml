<!--[if gte IE 9]>
  <style type="text/css">
    .gradient {
       filter: none;
    }
  </style>
<![endif]-->

<style>
    body {
        background-color: #E6E6E6;
    }


    body {
	background:white;
	font-family:Segoe,"Segoe UI",Calibri,Arial,Sans-Serif;
	padding:50px;
}

/* Framework start from here */
ul.tree,
ul.tree ul {
  list-style:none;
  margin:0;
  padding:0;
}

ul.tree ul {
  margin-left:10px; /* indentation */
  position:relative;
}

ul.tree ul:before {
  content:"";
  display:block;
  width:0;
  position:absolute;
  top:0;
  bottom:0;
  left:0;
  border-left:1px solid;
}

ul.tree li {
  margin:0;
  padding:0 12px; /* indentation + 2 */
  font-size:14px;
  line-height:20px; /* default list item `line-height` */
  color:#369;
  font-weight:bold;
  position:relative;
}

ul.tree ul li:before {
  content:"";
  display:block;
  width:10px; /* same with indentation */
  height:0;
  border-top:1px solid;
  position:absolute;
  top:10px;
  left:0;
}

ul.tree ul li:last-child:before {
  background:white; /* same with body background */
  height:auto;
  top:10px; /* (line-height/2) */
  bottom:0;
}
</style>

@if (false)
{
    <script src="../../Scripts/jquery-1.7.2-vsdoc.js" type="text/javascript"></script>
}

<div id="header" class="gradient">
    <h2>ChatR</h2>
</div>

<div id="myContainer" class="container-fluid">
    <div id="compose" class="row-fluid">
        <div class="span2"></div>
        <div class="span8">
            <div class="row-fluid">
                <div class="span10"><textarea id="compose-box" rows="2" cols="50" placeholder="Type your message here" data-bind="value:parentMessage"></textarea></div>
                <div class="span2"><button id="send-btn" type="button" data-bind="click:sendMessage" class="btn btn-large btn-primary">Send</button>   </div>
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <!-- This  is the contact box -->
        <div id="users-list" class="span2">
            <h4>Users</h4>
            <ul data-bind="foreach: usersModel.contacts">
                <li class="user-box"><span class="user-box-name" data-bind="text: username"></span></li>
            </ul>
        </div>
        <!-- This  is the chat box -->
        <div id="chat-list" class="span8">
            <ul class="tree"  data-bind="template: { name: 'message-template', foreach: messages,as: 'message' }"> </ul>
        </div>
    </div>
</div>

<script type="text/javascript" src="@Url.Content("/signalr/hubs")"></script>
<script type="text/javascript" src="@Url.Content("~/Js/chatR.js")"></script>
<script type="text/html" id="message-template">
    <!-- This  is the chat box -->
    <li>
        <span style="background-color: #D8D8D8; " data-bind="text: username"></span>
        <span class="" data-bind="html: content"></span>
        <span style="background-color: #D8D8D8; font-size:x-small" class="chat-listitem-timestamp" data-bind="text: timestamp.toLocaleTimeString()"></span>
        <div>
            <div data-bind="visible:!replySent()">
                <input type="text" id="newMessage" data-bind="value:newMessage" placeholder="Reply here..." />
                <button class="btn btn-small" data-bind="click: replyToMessage">Reply</button>
            </div>
            <div data-bind="if:replies().length > 0">
                <ul data-bind="template: { name: 'message-template', foreach: replies,as: 'message' }"></ul>
            </div>
        </div>
    </li>
</script>

<script type="text/javascript">


    Date.prototype.setISO8601 = function (dString) {

        var regexp = /(\d\d\d\d)(-)?(\d\d)(-)?(\d\d)(T)?(\d\d)(:)?(\d\d)(:)?(\d\d)(\.\d+)?(Z|([+-])(\d\d)(:)?(\d\d))/;

        if (dString.toString().match(new RegExp(regexp))) {
            var d = dString.match(new RegExp(regexp));
            var offset = 0;

            this.setUTCDate(1);
            this.setUTCFullYear(parseInt(d[1], 10));
            this.setUTCMonth(parseInt(d[3], 10) - 1);
            this.setUTCDate(parseInt(d[5], 10));
            this.setUTCHours(parseInt(d[7], 10));
            this.setUTCMinutes(parseInt(d[9], 10));
            this.setUTCSeconds(parseInt(d[11], 10));
            if (d[12])
                this.setUTCMilliseconds(parseFloat(d[12]) * 1000);
            else
                this.setUTCMilliseconds(0);
            if (d[13] != 'Z') {
                offset = (d[15] * 60) + parseInt(d[17], 10);
                offset *= ((d[14] == '-') ? -1 : 1);
                this.setTime(this.getTime() - offset * 60 * 1000);
            }
        }
        else {
            this.setTime(Date.parse(dString));
        }
        return this;
    };

    // Proxy creation
    var chatHub = $.connection.chatHub; // chatHub is the name of the Hub as declared in server side code

    var sendChatMsg = function (chatMessage) {

        if (chatMessage && chatMessage != null) {
            chatHub.server.send(chatMessage).done(function () {
                //$("#compose-box").val("");
            }).fail(function (e) {
                alert("Could not connect to server");
            });
        }
    }

    $(document).ready(function () {
        var chatHub = $.connection.chatHub; // chatHub is the name of the Hub as declared in server side code
        //alert(chat);
        var users = new chatR.connectedUsersViewModel();
        var currentUser = new chatR.user(@Html.Raw(Json.Encode(Model))); // The username chose by the user is stored in the model
        var chat = new chatR.chatViewModel(users, currentUser, sendChatMsg);

      
        chatHub.state.username = currentUser.username; // This is the round-trip state

        // Client-side event handlers, as declared inside the  Hub
        chatHub.client.onMessageReceived = function (message) {
            var date = new Date();
            date.setISO8601(message.Timestamp);
            //alert(message.Content);
            sessionStorage.setItem("Message", message);
            chat.addMessage(new chatR.chatMessage(message.Id, message.ParentId, message.NestLevel, message.Username, message.Content, date, sendChatMsg));
            $("#chat-list").scrollTo('max');

            //var jsonData = ko.toJSON(message);
            //alert(jsonData);
        }

        chatHub.client.leaves = function (userId, username, timestamp) {
            var disconnectedUser = new chatR.user(username, userId);
            users.customRemove(disconnectedUser);
        }

        chatHub.client.joins = function (userId, username, timestamp) {
            var connectedUser = new chatR.user(username, userId);
            users.contacts.push(connectedUser);
        }

        //ko.applyBindings(users, $("#users-list")[0]);
        ko.applyBindings(chat, document.getElementById("myContainer"));

        $.connection.hub.start()
                    .done(function () {
                        chatHub.server.getConnectedUsers()
                                    .done(function (connectedUsers) {
                                        ko.utils.arrayForEach(connectedUsers, function (item) {
                                            users.contacts.push(new chatR.user(item.Username, item.Id));
                                        });
                                    }).done(function () {
                                        chatHub.server.joined();
                                    });
                    });
    });

</script>
